# ===================================================================
# Python FastAPI ë¹Œë“œ ê²€ì¦ ì›Œí¬í”Œë¡œìš° (CI Only)
# ===================================================================
#
# ì„¤ëª…:
# - main ë¸Œëžœì¹˜ì— push ì‹œ Docker ë¹Œë“œê°€ ì •ìƒì ìœ¼ë¡œ ë˜ëŠ”ì§€ë§Œ ê²€ì¦
# - ë°°í¬ëŠ” ìˆ˜í–‰í•˜ì§€ ì•ŠìŒ (deploy ë¸Œëžœì¹˜ì—ì„œë§Œ ë°°í¬)
#
# ===================================================================

name: PROJECT-PYTHON-CI

# ===================================================================
# íŠ¸ë¦¬ê±° ì„¤ì •
# ===================================================================
on:
  push:
    branches:
      - main  # main ë¸Œëžœì¹˜ push ì‹œ ë¹Œë“œ ê²€ì¦
  pull_request:
    branches:
      - main  # main ë¸Œëžœì¹˜ë¡œì˜ PR ì‹œ ë¹Œë“œ ê²€ì¦
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

# ===================================================================
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# ===================================================================
env:
  # ðŸ”§ í”„ë¡œì íŠ¸ ì„¤ì •
  PROJECT_NAME: "mapsy-ai"

  # ðŸ Python ì„¤ì •
  PYTHON_VERSION: "3.13"

jobs:
  # ===================================================================
  # ë¹Œë“œ ê²€ì¦ ìž‘ì—…
  # ===================================================================
  build-check:
    name: Python FastAPI ë¹Œë“œ ê²€ì¦
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. .env íŒŒì¼ ìƒì„± (ë¹Œë“œ ê²€ì¦ìš©)
      - name: .env íŒŒì¼ ìƒì„±
        run: |
          cat > .env << 'EOF'
          ${{ secrets.ENV_FILE }}
          EOF
          echo "âœ… .env íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"

      # 3. Docker ë¹Œë“œ í™˜ê²½ ì„¤ì •
      - name: Docker ë¹Œë“œí™˜ê²½ ì„¤ì •
        uses: docker/setup-buildx-action@v3

      # 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ (push ì—†ì´ ê²€ì¦ë§Œ)
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ê²€ì¦
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false  # í‘¸ì‹œí•˜ì§€ ì•ŠìŒ (ë¹Œë“œ ê²€ì¦ë§Œ)
          tags: ${{ env.PROJECT_NAME }}:build-check
          # GitHub Actions ìºì‹œ ì‚¬ìš©
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 5. ë¹Œë“œ ì„±ê³µ ë©”ì‹œì§€
      - name: ë¹Œë“œ ê²€ì¦ ì™„ë£Œ
        run: |
          echo "âœ… Docker ë¹Œë“œ ê²€ì¦ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo ""
          echo "ðŸ“‹ ë¹Œë“œ ì •ë³´:"
          echo "  ðŸŽ¯ í”„ë¡œì íŠ¸: ${{ env.PROJECT_NAME }}"
          echo "  ðŸŒ¿ ë¸Œëžœì¹˜: ${{ github.ref_name }}"
          echo "  ðŸ“ ì»¤ë°‹: ${{ github.sha }}"
          echo "  â° ê²€ì¦ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
