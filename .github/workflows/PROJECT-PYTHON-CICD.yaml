# ===================================================================
# Python FastAPI ì „ìš© CI/CD ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ===================================================================

name: PROJECT-PYTHON-CICD

# ===================================================================
# ðŸ“‹ í•„ìˆ˜ GitHub Secrets ì„¤ì • ê°€ì´ë“œ
# ===================================================================
#
# âš ï¸ ì‚¬ìš©í•˜ê¸° ì „ì— ë°˜ë“œì‹œ ë‹¤ìŒ GitHub Secretsë¥¼ ì„¤ì •í•˜ì„¸ìš”!
# (ì €ìž¥ì†Œ Settings > Secrets and variables > Actionsì—ì„œ ì„¤ì •)
#
# ðŸ”§ í•„ìˆ˜ Secrets:
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ Secret ì´ë¦„                 â”‚ ì„¤ëª…                               â”‚
# â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
# â”‚ DOCKERHUB_USERNAME          â”‚ DockerHub ì‚¬ìš©ìžëª…                 â”‚
# â”‚ DOCKERHUB_TOKEN             â”‚ DockerHub ì•¡ì„¸ìŠ¤ í† í°              â”‚
# â”‚ SERVER_HOST                 â”‚ ë°°í¬ ëŒ€ìƒ ì„œë²„ IP/ë„ë©”ì¸           â”‚
# â”‚ SERVER_USER                 â”‚ ì„œë²„ SSH ì ‘ì† ì‚¬ìš©ìžëª…             â”‚
# â”‚ SERVER_PASSWORD             â”‚ ì„œë²„ SSH ì ‘ì† ë¹„ë°€ë²ˆí˜¸             â”‚
# â”‚ ENV_FILE                    â”‚ .env íŒŒì¼ ì „ì²´ ë‚´ìš©                â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ðŸ§ª ì„ íƒì  Secrets (test ë¸Œëžœì¹˜ ì‚¬ìš©ì‹œì—ë§Œ):
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
# â”‚ PYTHON_TEST_PORT            â”‚ test ë¸Œëžœì¹˜ ë°°í¬ í¬íŠ¸ (ê¸°ë³¸: 8001) â”‚
# â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
#
# ===================================================================

# ===================================================================
# íŠ¸ë¦¬ê±° ì„¤ì •
# ===================================================================
on:
  push:
    branches:
      - deploy  # í”„ë¡œë•ì…˜ ë°°í¬ (í•„ìˆ˜)
      - test    # í…ŒìŠ¤íŠ¸ í™˜ê²½ ë°°í¬ (ì„ íƒì‚¬í•­)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

# ===================================================================
# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
# ===================================================================
env:
  # ðŸ”§ í”„ë¡œì íŠ¸ ì„¤ì •
  PROJECT_NAME: "mapsy-ai"
  PROJECT_MAIN_PORT: "8092"

  # ðŸ Python ì„¤ì •
  PYTHON_VERSION: "3.13"

jobs:
  # ===================================================================
  # ë¹Œë“œ ìž‘ì—…
  # ===================================================================
  build:
    name: Python FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. ë””ìŠ¤í¬ ê³µê°„ í™•ë³´
      - name: ë””ìŠ¤í¬ ê³µê°„ í™•ë³´
        run: |
          echo "ðŸ“Š ë¹Œë“œ ì „ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h
          
          echo "ðŸ§¹ ë¶ˆí•„ìš”í•œ íŒŒì¼ ì •ë¦¬ ì¤‘..."
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /usr/local/share/boost || true
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true
          
          echo "ðŸ³ Docker ì‹œìŠ¤í…œ ì •ë¦¬ ì¤‘..."
          docker system prune -af --volumes || true
          
          echo "ðŸ“Š ì •ë¦¬ í›„ ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h

      # 3. .env íŒŒì¼ ìƒì„±
      - name: .env íŒŒì¼ ìƒì„±
        run: |
          cat > .env << 'EOF'
          ${{ secrets.ENV_FILE }}
          EOF
          echo "âœ… .env íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"

      # 4. Docker ë¹Œë“œ í™˜ê²½ ì„¤ì •
      - name: Docker ë¹Œë“œí™˜ê²½ ì„¤ì •
        uses: docker/setup-buildx-action@v3

      # 5. DockerHub ë¡œê·¸ì¸
      - name: DockerHub ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 6. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.PROJECT_NAME }}:${{ github.ref_name }}
          # GitHub Actions ìºì‹œ ì‚¬ìš© (ë¡œì»¬ ë””ìŠ¤í¬ ê³µê°„ ì ˆì•½)
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # 7. ë¹Œë“œ í›„ ì •ë¦¬
      - name: ë¹Œë“œ í›„ ì •ë¦¬
        if: always()
        run: |
          echo "ðŸ§¹ ë¹Œë“œ í›„ ì •ë¦¬ ì¤‘..."
          docker system prune -f || true
          echo "ðŸ“Š ìµœì¢… ë””ìŠ¤í¬ ì‚¬ìš©ëŸ‰:"
          df -h

  # ===================================================================
  # ë°°í¬ ìž‘ì—…
  # ===================================================================
  deploy:
    name: ì›ê²© ì„œë²„ ë°°í¬
    needs: build
    runs-on: ubuntu-latest

    steps:
      # SSHë¥¼ í†µí•œ ì›ê²© ì„œë²„ ë°°í¬ ì‹¤í–‰
      - name: Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 2022
          command_timeout: 600s  # ëª…ë ¹ ì‹¤í–‰ íƒ€ìž„ì•„ì›ƒ 10ë¶„
          timeout: 60s           # SSH ì—°ê²° íƒ€ìž„ì•„ì›ƒ 60ì´ˆ
          script: |
            set -e

            # ============================================================
            # ë°°í¬ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
            # ============================================================
            echo "ðŸ”§ í™˜ê²½ë³€ìˆ˜ ì„¤ì •.."
            export PATH=$PATH:/usr/local/bin
            export PW=${{ secrets.SERVER_PASSWORD }}

            # GitHubì—ì„œ ì „ë‹¬ë°›ì€ ë¸Œëžœì¹˜ëª…
            BRANCH=${{ github.ref_name }}

            # í”„ë¡œì íŠ¸ ì„¤ì •
            PROJECT_NAME="${{ env.PROJECT_NAME }}"

            # ============================================================
            # ë¸Œëžœì¹˜ë³„ í¬íŠ¸ ë° ì»¨í…Œì´ë„ˆëª… ì„¤ì •
            # ============================================================
            # ê¸°ë³¸ê°’ ì„¤ì •
            PORT=8000
            CONTAINER_NAME="${PROJECT_NAME}"

            # ë¸Œëžœì¹˜ì— ë”°ë¥¸ í™˜ê²½ë³„ ì„¤ì •
            if [ "$BRANCH" == "main" ] || [ "$BRANCH" == "deploy" ]; then
              # ðŸ­ í”„ë¡œë•ì…˜ í™˜ê²½ (main/deploy ë¸Œëžœì¹˜)
              PORT=${{ env.PROJECT_MAIN_PORT }}
              CONTAINER_NAME="${PROJECT_NAME}"
              echo "ðŸ­ í”„ë¡œë•ì…˜ í™˜ê²½ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤"

            elif [ "$BRANCH" == "test" ]; then
              # ðŸ§ª í…ŒìŠ¤íŠ¸ í™˜ê²½ (test ë¸Œëžœì¹˜)
              PORT=${{ secrets.PYTHON_TEST_PORT}}
              CONTAINER_NAME="${PROJECT_NAME}-test"
              echo "ðŸ§ª í…ŒìŠ¤íŠ¸ í™˜ê²½ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤"

            else
              # âš ï¸ ê¸°íƒ€ ë¸Œëžœì¹˜
              echo "âš ï¸ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œëžœì¹˜ìž…ë‹ˆë‹¤: $BRANCH"
              exit 1
            fi

            # ì„¤ì • ì •ë³´ ì¶œë ¥
            echo "ðŸ“‹ ë°°í¬ ì„¤ì • ì •ë³´:"
            echo "  - ë¸Œëžœì¹˜: $BRANCH"
            echo "  - í”„ë¡œì íŠ¸: $PROJECT_NAME"
            echo "  - ì»¨í…Œì´ë„ˆ ì´ë¦„: $CONTAINER_NAME"
            echo "  - í¬íŠ¸: $PORT"
            echo "  - Docker ì´ë¯¸ì§€: ${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:${BRANCH}"

            # ============================================================
            # Docker ì´ë¯¸ì§€ í’€ (Pull)
            # ============================================================
            echo "â¬‡ï¸ Docker ì´ë¯¸ì§€ í’€: ${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:${BRANCH}"
            echo $PW | sudo -S docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:${BRANCH}

            # ============================================================
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            # ============================================================
            echo "ðŸ§¹ ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì¡´ìž¬ ì—¬ë¶€ í™•ì¸ ì¤‘..."

            # ë™ì¼í•œ ì´ë¦„ì˜ ì»¨í…Œì´ë„ˆê°€ ì¡´ìž¬í•˜ëŠ”ì§€ í™•ì¸
            if echo $PW | sudo -S docker ps -a --format '{{.Names}}' | grep -Eq "^${CONTAINER_NAME}\$"; then
              echo "âš ï¸ ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì´(ê°€) ì¡´ìž¬í•©ë‹ˆë‹¤. ì¤‘ì§€ ë° ì‚­ì œ ì¤‘..."
              echo $PW | sudo -S docker rm -f $CONTAINER_NAME
              echo "âœ… ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "â„¹ï¸ ì¡´ìž¬í•˜ëŠ” ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì´(ê°€) ì—†ìŠµë‹ˆë‹¤."
            fi

            # ============================================================
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            # ============================================================
            echo "ðŸš€ ìƒˆë¡œìš´ ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì‹¤í–‰ ì¤‘..."

            # Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰
            # - í¬íŠ¸ ë§¤í•‘: ${PORT}:8000 (ì™¸ë¶€í¬íŠ¸:ë‚´ë¶€í¬íŠ¸)
            # - ì‹œê°„ëŒ€: Asia/Seoul
            # - ë³¼ë¥¨ ë§ˆìš´íŠ¸: ë¡œì»¬ ì‹œê°„ ë™ê¸°í™” ë° í”„ë¡œì íŠ¸ ë°ì´í„°
            # âš ï¸ .env íŒŒì¼ì€ ì´ë¯¸ Docker ì´ë¯¸ì§€ì— í¬í•¨ë˜ì–´ ìžˆìŠµë‹ˆë‹¤
            echo $PW | sudo -S docker run -d \
              -p ${PORT}:8000 \
              --name $CONTAINER_NAME \
              -e TZ=Asia/Seoul \
              -v /etc/localtime:/etc/localtime:ro \
              -v /volume1/projects/mapsy/ai:/mnt/mapsy \
              ${{ secrets.DOCKERHUB_USERNAME }}/${PROJECT_NAME}:${BRANCH}

            # ============================================================
            # ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬
            # ============================================================
            echo "â³ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘... (10ì´ˆ)"
            sleep 10

            echo "ðŸ¥ ì»¨í…Œì´ë„ˆ í—¬ìŠ¤ì²´í¬ ì¤‘..."
            if echo $PW | sudo -S docker ps --format '{{.Names}}' | grep -Eq "^${CONTAINER_NAME}\$"; then
              echo "âœ… ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì´(ê°€) ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ ì¤‘ìž…ë‹ˆë‹¤"
            else
              echo "âŒ ì»¨í…Œì´ë„ˆ $CONTAINER_NAME ì‹¤í–‰ ì‹¤íŒ¨"
              echo "ðŸ“‹ ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
              echo $PW | sudo -S docker logs $CONTAINER_NAME || true
              exit 1
            fi

            # ============================================================
            # ë°°í¬ ì™„ë£Œ í™•ì¸
            # ============================================================
            echo "âœ… ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo ""
            echo "ðŸ“‹ ë°°í¬ ê²°ê³¼ ìš”ì•½:"
            echo "  ðŸŽ¯ í”„ë¡œì íŠ¸: $PROJECT_NAME"
            echo "  ðŸŒ¿ ë¸Œëžœì¹˜: $BRANCH"
            echo "  ðŸ³ ì»¨í…Œì´ë„ˆ: $CONTAINER_NAME"
            echo "  ðŸŒ í¬íŠ¸: $PORT"
            echo "  â° ë°°í¬ ì‹œê°„: $(date '+%Y-%m-%d %H:%M:%S')"
            echo ""
            echo "ðŸ”— ì ‘ì† URL: http://${{ secrets.SERVER_HOST }}:${PORT}/docs"
